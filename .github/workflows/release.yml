name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-executables:
    name: Build Executables (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: x86_64
            xray_arch: Xray-linux-64
            pyinstaller_target: ""
          - arch: aarch64
            xray_arch: Xray-linux-arm64-v8a
            pyinstaller_target: ""
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install pyinstaller pyyaml flask

    - name: Build executables (native x86_64)
      if: matrix.arch == 'x86_64'
      run: |
        # Build xray-client
        pyinstaller --onefile --name xray-client --clean --noconfirm --strip \
          --hidden-import yaml \
          xray-client.py

        # Build xray-webui
        pyinstaller --onefile --name xray-webui --clean --noconfirm --strip \
          --hidden-import yaml \
          --hidden-import flask \
          --collect-all flask \
          web-ui.py

    - name: Build executables (cross-compile aarch64)
      if: matrix.arch == 'aarch64'
      uses: uraimo/run-on-arch-action@v3
      with:
        arch: aarch64
        distro: ubuntu22.04
        githubToken: ${{ github.token }}
        run: |
          apt-get update && apt-get install -y python3 python3-pip python3-venv
          python3 -m venv /tmp/build-venv
          /tmp/build-venv/bin/pip install pyinstaller pyyaml flask

          # Build xray-client
          /tmp/build-venv/bin/pyinstaller --onefile --name xray-client --clean --noconfirm --strip \
            --hidden-import yaml \
            xray-client.py

          # Build xray-webui
          /tmp/build-venv/bin/pyinstaller --onefile --name xray-webui --clean --noconfirm --strip \
            --hidden-import yaml \
            --hidden-import flask \
            --collect-all flask \
            web-ui.py

    - name: Upload executables
      uses: actions/upload-artifact@v4
      with:
        name: executables-${{ matrix.arch }}
        path: |
          dist/xray-client
          dist/xray-webui

  build-offline-package:
    name: Build Offline Package
    needs: build-executables
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Download executables
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Get Xray Latest Version
      id: get_version
      run: |
        latest=$(curl -s https://api.github.com/repos/XTLS/Xray-core/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
        echo "version=$latest" >> $GITHUB_OUTPUT
        echo "Xray Latest Version: $latest"

    - name: Download Xray
      run: |
        VERSION=${{ steps.get_version.outputs.version }}
        mkdir -p offline-package

        # Download multiple architectures
        for arch in Xray-linux-64 Xray-linux-arm64-v8a; do
          echo "Downloading $arch..."
          curl -fsSL -o "offline-package/${arch}.zip" \
            "https://github.com/XTLS/Xray-core/releases/download/${VERSION}/${arch}.zip" || \
          curl -fsSL -o "offline-package/${arch}.zip" \
            "https://ghproxy.com/https://github.com/XTLS/Xray-core/releases/download/${VERSION}/${arch}.zip"
        done

    - name: Download GeoData
      run: |
        mkdir -p offline-package
        curl -fsSL -o offline-package/geoip.dat \
          https://github.com/v2fly/geoip/releases/latest/download/geoip.dat || \
        curl -fsSL -o offline-package/geoip.dat \
          https://ghproxy.com/https://github.com/v2fly/geoip/releases/latest/download/geoip.dat

        curl -fsSL -o offline-package/geosite.dat \
          https://github.com/v2fly/domain-list-community/releases/latest/download/dlc.dat || \
        curl -fsSL -o offline-package/geosite.dat \
          https://ghproxy.com/https://github.com/v2fly/domain-list-community/releases/latest/download/dlc.dat

    - name: Prepare Offline Package (x86_64)
      run: |
        mkdir -p xray-client-offline

        # Copy install scripts
        cp install.sh xray-client-offline/
        cp quick-install.sh xray-client-offline/
        cp README.md xray-client-offline/
        cp LICENSE xray-client-offline/

        # Copy pre-built executables (no Python needed on target)
        cp artifacts/executables-x86_64/xray-client xray-client-offline/
        cp artifacts/executables-x86_64/xray-webui xray-client-offline/
        chmod +x xray-client-offline/xray-client xray-client-offline/xray-webui

        # Also include Python sources as fallback
        cp xray-client.py xray-client-offline/
        cp web-ui.py xray-client-offline/

        # Copy Xray (x64)
        unzip -q offline-package/Xray-linux-64.zip -d temp_xray
        cp temp_xray/xray xray-client-offline/xray-bin
        rm -rf temp_xray

        # Copy geodata
        cp offline-package/geoip.dat xray-client-offline/
        cp offline-package/geosite.dat xray-client-offline/

        # Create install-offline.sh
        cat > xray-client-offline/install-offline.sh << 'EOF'
        #!/bin/bash
        set -e
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        NC='\033[0m'

        echo -e "${YELLOW}Xray Client 离线安装${NC}"
        echo ""

        if [ "$EUID" -ne 0 ]; then
            echo -e "${RED}请使用 root 权限运行此脚本${NC}"
            exit 1
        fi

        if [ ! -f "xray-bin" ]; then
            echo -e "${RED}错误: 未找到 xray-bin 文件${NC}"
            exit 1
        fi

        # 复制 Xray 到临时目录
        cp xray-bin /tmp/xray
        chmod +x /tmp/xray

        # 运行安装脚本，选择离线模式
        export NETWORK_MODE="offline"
        bash install.sh

        echo ""
        echo -e "${GREEN}安装完成!${NC}"
        echo ""
        EOF
        chmod +x xray-client-offline/install-offline.sh

        # Create README for offline package
        cat > xray-client-offline/README.txt << README_EOF
        Xray Client 离线安装包
        ========================

        版本: ${{ github.ref_name }}
        Xray 版本: ${{ steps.get_version.outputs.version }}
        架构: x86_64
        包含预编译可执行文件（无需 Python 环境）

        安装方法:
          sudo ./install-offline.sh

        更多说明见 README.md
        README_EOF

        # Create archive
        tar czf xray-client-offline-x86_64.tar.gz xray-client-offline/
        rm -rf xray-client-offline

    - name: Prepare Offline Package (aarch64)
      run: |
        mkdir -p xray-client-offline

        # Copy install scripts
        cp install.sh xray-client-offline/
        cp quick-install.sh xray-client-offline/
        cp README.md xray-client-offline/
        cp LICENSE xray-client-offline/

        # Copy pre-built executables
        cp artifacts/executables-aarch64/xray-client xray-client-offline/
        cp artifacts/executables-aarch64/xray-webui xray-client-offline/
        chmod +x xray-client-offline/xray-client xray-client-offline/xray-webui

        # Also include Python sources as fallback
        cp xray-client.py xray-client-offline/
        cp web-ui.py xray-client-offline/

        # Copy Xray (arm64)
        unzip -q offline-package/Xray-linux-arm64-v8a.zip -d temp_xray
        cp temp_xray/xray xray-client-offline/xray-bin
        rm -rf temp_xray

        # Copy geodata
        cp offline-package/geoip.dat xray-client-offline/
        cp offline-package/geosite.dat xray-client-offline/

        # Create install-offline.sh (same as x86_64)
        cat > xray-client-offline/install-offline.sh << 'EOF'
        #!/bin/bash
        set -e
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        NC='\033[0m'

        echo -e "${YELLOW}Xray Client 离线安装${NC}"
        echo ""

        if [ "$EUID" -ne 0 ]; then
            echo -e "${RED}请使用 root 权限运行此脚本${NC}"
            exit 1
        fi

        if [ ! -f "xray-bin" ]; then
            echo -e "${RED}错误: 未找到 xray-bin 文件${NC}"
            exit 1
        fi

        cp xray-bin /tmp/xray
        chmod +x /tmp/xray

        export NETWORK_MODE="offline"
        bash install.sh

        echo ""
        echo -e "${GREEN}安装完成!${NC}"
        echo ""
        EOF
        chmod +x xray-client-offline/install-offline.sh

        cat > xray-client-offline/README.txt << README_EOF
        Xray Client 离线安装包
        ========================

        版本: ${{ github.ref_name }}
        Xray 版本: ${{ steps.get_version.outputs.version }}
        架构: aarch64
        包含预编译可执行文件（无需 Python 环境）

        安装方法:
          sudo ./install-offline.sh

        更多说明见 README.md
        README_EOF

        tar czf xray-client-offline-aarch64.tar.gz xray-client-offline/
        rm -rf xray-client-offline

    - name: List packages
      run: |
        echo "Offline packages:"
        ls -lh xray-client-offline-*.tar.gz

        echo ""
        echo "Standalone executables:"
        ls -lh artifacts/executables-x86_64/
        ls -lh artifacts/executables-aarch64/

    - name: Rename executables with architecture suffix
      run: |
        cp artifacts/executables-x86_64/xray-client xray-client-x86_64
        cp artifacts/executables-x86_64/xray-webui xray-webui-x86_64
        cp artifacts/executables-aarch64/xray-client xray-client-aarch64
        cp artifacts/executables-aarch64/xray-webui xray-webui-aarch64

    - name: Upload to Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          xray-client-offline-x86_64.tar.gz
          xray-client-offline-aarch64.tar.gz
          xray-client-x86_64
          xray-webui-x86_64
          xray-client-aarch64
          xray-webui-aarch64
        body: |
          ## Xray Client ${{ github.ref_name }}

          ### 独立可执行文件（推荐）
          下载对应架构的 `xray-client` 和 `xray-webui` 可直接运行，无需安装 Python 环境。
          - x86_64: `xray-client-x86_64` / `xray-webui-x86_64`
          - aarch64: `xray-client-aarch64` / `xray-webui-aarch64`

          ### 离线安装包
          - `xray-client-offline-x86_64.tar.gz` - x86_64 架构离线包
          - `xray-client-offline-aarch64.tar.gz` - ARM64 架构离线包

          包含 Xray 核心、GeoIP/GeoSite 数据和预编译可执行文件。

          ### 快速安装
          ```bash
          curl -fsSL -o install.sh https://cdn.jsdelivr.net/gh/sivdead/xray-client@${{ github.ref_name }}/install.sh
          sudo bash install.sh
          ```

          ### 更新日志
          见 [CHANGELOG.md](CHANGELOG.md)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
